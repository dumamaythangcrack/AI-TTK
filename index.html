<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TTK AI Chat V1.1 - Monochrome + Spinner Fix</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{
  --bg-dark:#0a0a0f;
  --bg-light:#f9f9f9;
  --text-dark:#e0e0e0;
  --text-light:#111;
  --accent:#a855f7;
  --accent-hover:#b366ff;
  --bubble-ai-dark:rgba(30,30,30,0.75);
  --bubble-user-dark:rgba(50,50,50,0.55);
  --bubble-ai-light:rgba(245,245,245,0.85);
  --bubble-user-light:rgba(220,220,220,0.8);
  --modal-bg: rgba(20,20,20,0.7);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:'Inter',sans-serif;
  background: var(--bg-dark);
  color: var(--text-dark);
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  position:relative;
  transition:0.5s background ease,color 0.5s;
}
body::before{
  content:"";
  position:absolute;
  width:100%;
  height:100%;
  background: rgba(15,15,15,0.4);
  filter: blur(50px);
  transform: translate3d(0,0,0);
  z-index:0;
}

/* === Splash Screen === */
#splashScreen{
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: var(--bg-dark);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:9999;
  opacity:1;
  transition: opacity 0.8s ease;
}
#splashScreen.hidden{opacity:0;pointer-events:none;}
#splashScreen .ai-spinner{
  display:flex;
  align-items:center;
  gap:10px;
}
#splashScreen .ai-spinner .spinner{
  width:30px;
  height:30px;
  border:4px solid rgba(255,255,255,0.2);
  border-top:4px solid var(--accent);
  border-radius:50%;
  animation: spin 1s linear infinite;
}
#splashScreen span{
  font-size:1.1em;
  color: var(--text-dark);
  font-weight:500;
  margin-top:10px;
}

/* Spinner keyframes */
@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

/* === Spinner Bubble AI === */
.message.ai .ai-spinner{
  display:flex;
  align-items:center;
  gap:6px;
}
.message.ai .ai-spinner .spinner{
  width:20px;
  height:20px;
  border:2px solid rgba(255,255,255,0.2);
  border-top:2px solid var(--accent);
  border-radius:50%;
  animation: spin 1s linear infinite;
}
.message.ai .ai-spinner span{
  font-size:0.85em;
  color: var(--text-dark);
}

/* === GI·ªÆ NGUY√äN CSS C≈® === */
header{
  padding:15px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background: rgba(20,20,20,0.5);
  backdrop-filter: blur(12px);
  border-radius:12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  position:relative;
  z-index:1;
  transition: all 0.4s ease;
}
header span{ font-size:0.9em; opacity:0.7; color: var(--text-dark);}
.mode-toggle,.info-btn{ background:none; border:none; color:inherit; font-size:1.5em; cursor:pointer; transition:all 0.3s ease; margin-left:10px;}
.mode-toggle:hover,.info-btn:hover{ transform:scale(1.05);}
#messages{ flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:14px; z-index:1; position:relative; scroll-behavior:smooth;}
#messages::-webkit-scrollbar{width:8px;}
#messages::-webkit-scrollbar-track{background:transparent;}
#messages::-webkit-scrollbar-thumb{ background: var(--accent); border-radius:8px;}
.message{ display:flex; max-width:75%; opacity:0; transform:translateY(20px) scale(0.95); animation: slide-up 0.5s ease-out forwards; position:relative;}
.message.user{align-self:flex-end;}
.message.ai{align-self:flex-start;}
.bubble{ padding:16px 20px; word-wrap:break-word; line-height:1.5; white-space:pre-wrap; display:flex; flex-direction:column; gap:8px; backdrop-filter:blur(12px); background: var(--bubble-ai-dark); border-radius:12px; position:relative; transition:0.3s; overflow:hidden;}
.user .bubble{ background:var(--bubble-user-dark); color: var(--text-dark);}
.ai .bubble{ padding:20px 25px; border-radius:16px 16px 16px 4px; background: var(--bubble-ai-dark); border-left: 3px solid var(--accent);}
.ai .bubble pre{ background: rgba(25,25,25,0.7); border-left: 2px solid #555; border-radius:6px; padding:10px 14px; overflow-x:auto; font-family:'Share Tech Mono','Orbitron',monospace; color: var(--text-dark);}
.ai .bubble code{ background: rgba(50,50,50,0.3); border-radius:4px; padding:2px 6px; font-family:'Share Tech Mono','Orbitron',monospace; color:var(--accent);}
.bubble::before{ content:""; position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.02), transparent 70%); mix-blend-mode:screen; transition: transform 0.2s ease;}
.bubble.glow{ box-shadow: 0 0 6px var(--accent, rgba(168,85,247,0.5)); transform: scale(1.01);}
.avatar{ width:42px; height:42px; border-radius:50%; margin-right:10px; flex-shrink:0; transition: transform 0.3s;}
.message.ai .avatar{background:#a855f7 url('https://i.ibb.co/dsCLWn26/images.jpg') center/cover no-repeat;}
.message.user .avatar{background:#555 url('https://i.ibb.co/PsYbWjjR/png-clipart-aspria-fitness-computer-icons-user-my-account-icon-miscellaneous-monochrome-thumbnail.png') center/cover no-repeat;}
.message.ai .avatar:hover,.message.user .avatar:hover{ transform: scale(1.1);}
.chat-input{ display:flex; padding:14px; gap:10px; background: rgba(20,20,20,0.5); backdrop-filter: blur(12px); border-radius:16px; position:relative; z-index:1;}
.chat-input input[type="text"]{ flex:1; padding:14px; border-radius:12px; border:none; background: rgba(255,255,255,0.08); color: var(--text-dark); font-family:'Inter',sans-serif; font-size:1em; outline:none; transition:0.3s;}
.chat-input input[type="text"]:focus{ box-shadow: 0 0 6px var(--accent); background: rgba(255,255,255,0.12);}
.send-btn{ padding:12px 22px; border:none; border-radius:12px; background: var(--accent); color:#fff; font-weight:bold; cursor:pointer; font-family:'Orbitron','Share Tech Mono',monospace; transition:0.3s;}
.send-btn:hover{ box-shadow:0 0 6px var(--accent);}
.icon-btn{ background:none;border:none;font-size:1.5em;color:var(--accent);cursor:pointer;transition:0.3s;}
.icon-btn:hover{ text-shadow:0 0 6px var(--accent);}
.file-input{display:none;}
.image-preview{ width:70px;height:70px;border-radius:16px;object-fit:cover;border:2px solid var(--accent);cursor:pointer;position:relative; transition:0.3s;}
.image-preview:hover{ box-shadow:0 0 6px var(--accent);}
body.light{ background:var(--bg-light); color:var(--text-light);}
body.light .ai .bubble{background:var(--bubble-ai-light);color:var(--text-light);}
body.light .user .bubble{background:var(--bubble-user-light);}
body.light .chat-input input{background:rgba(255,255,255,0.8);color:#111;}
@keyframes slide-up{0%{opacity:0;transform:translateY(20px) scale(0.95);}100%{opacity:1;transform:translateY(0) scale(1);}}

/* Info Modal */
#infoModal{ position:fixed;top:0;left:0;width:100%;height:100%; background: rgba(0,0,0,0.5); display:flex;justify-content:center;align-items:center; opacity:0;pointer-events:none;transition:0.3s; z-index:10;}
#infoModal.show{ opacity:1;pointer-events:auto;}
#infoModal .modal-content{ background: var(--modal-bg); backdrop-filter: blur(12px); padding:20px 30px; border-radius:16px; max-width:400px; text-align:center; color: var(--text-dark); position:relative;}
#infoModal .modal-content h2{margin-bottom:10px;font-family:'Orbitron',monospace;}
#infoModal .modal-content p{margin:6px 0;}
#infoModal .close-btn{ position:absolute;top:10px;right:15px; background:none;border:none;color:var(--text-dark);font-size:1.5em;cursor:pointer;}
</style>
</head>
<body>

<!-- === Splash Screen === -->
<div id="splashScreen">
  <div class="ai-spinner">
    <div class="spinner"></div>
    <span>ƒêang load h·ªá th·ªëng Base64...</span>
  </div>
</div>

<header>
  ü§ñ TTK AI <span>Dev by Tr·∫ßn Tu·∫•n Khang</span>
  <div>
    <button class="mode-toggle" id="modeToggle">üåì</button>
    <button class="info-btn" id="infoBtn">‚ÑπÔ∏è</button>
  </div>
</header>
<div id="messages"></div>
<div class="chat-input">
  <button class="icon-btn" id="imgBtn">üñºÔ∏è</button>
  <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
  <input type="text" id="input" placeholder="Nh·∫≠p tin nh·∫Øn ho·∫∑c m√¥ t·∫£ ·∫£nh...">
  <button id="send" class="send-btn">G·ª≠i</button>
</div>

<!-- Info Modal -->
<div id="infoModal">
  <div class="modal-content">
    <button class="close-btn" id="closeModal">&times;</button>
    <h2>TTK AI V1.1</h2>
    <p><strong>M√¥ h√¨nh n·ªÅn t·∫£ng:</strong> Gemini 2.0 Flash</p>
    <p><strong>Developer:</strong> Tr·∫ßn Tu·∫•n Khang</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>
// === Splash Screen Logic ===
window.addEventListener("load", ()=>{
  const splash=document.getElementById("splashScreen");
  setTimeout(()=>{
    splash.classList.add("hidden");
    setTimeout(()=>{
      splash.style.display="none";
      addMessage("Xin ch√†o üëã! M√¨nh l√† **TTK AI** ‚Äì tr·ª£ l√Ω ·∫£o c·ªßa b·∫°n. H√£y g·ª≠i tin nh·∫Øn ho·∫∑c ·∫£nh ƒë·ªÉ m√¨nh gi√∫p nh√©!","ai");
    },800);
  },2000);
});

// === GI·ªÆ NGUY√äN LOGIC JS C≈® ===
const API_KEY="AIzaSyCrzfPbVtDLKBAsdKO31vdHysBb8JDQYUU";
const MODEL="gemini-2.5-flash";
const endpoint=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
const messagesDiv=document.getElementById("messages");
const input=document.getElementById("input");
const sendBtn=document.getElementById("send");
const modeToggle=document.getElementById("modeToggle");
const imgBtn=document.getElementById("imgBtn");
const fileInput=document.getElementById("fileInput");
let selectedImages=[];

document.addEventListener("mousemove", e=>{
  const x = e.clientX/window.innerWidth*30;
  const y = e.clientY/window.innerHeight*30;
  document.body.style.setProperty('--bg-offset-x', `${x}px`);
  document.body.style.setProperty('--bg-offset-y', `${y}px`);
  document.querySelectorAll('.bubble').forEach(b=>{
    const rect=b.getBoundingClientRect();
    const cx=e.clientX-(rect.left+rect.width/2);
    const cy=e.clientY-(rect.top+rect.height/2);
    const dist=Math.sqrt(cx*cx+cy*cy);
    if(dist<150){b.classList.add('glow');} else {b.classList.remove('glow');}
    b.style.setProperty('--shineX', `${cx}px`);
    b.style.setProperty('--shineY', `${cy}px`);
  });
});

function renderMessageContent(text){
  const container = document.createElement("div");
  // Thay v√¨ parse Markdown, gi·ªØ nguy√™n k√Ω t·ª±
container.innerHTML = text
  .replace(/(\/\/.*)/g, '<span style="color:#aaa;font-size:0.85em;">$1</span>')
  .replace(/\n/g, "<br>")
  .replace(/ /g, "&nbsp;");
  return container;
}

function addMessage(text,sender,isTyping=false,images=[]){
  const msg=document.createElement("div");
  msg.className=`message ${sender}`;
  const avatar=document.createElement("div");
  avatar.className="avatar";
  msg.appendChild(avatar);
  const bubble=document.createElement("div");
  bubble.className="bubble";
  images.forEach(src=>{
    const img=document.createElement("img");
    img.src=src; img.className="image-preview";
    img.onclick=()=>{selectedImages=selectedImages.filter(s=>s!==src); img.remove();};
    bubble.appendChild(img);
  });

  if(isTyping && sender==="ai"){
    const spinnerDiv=document.createElement("div");
    spinnerDiv.className="ai-spinner";
    const spinnerCircle=document.createElement("div");
    spinnerCircle.className="spinner";
    const spanText=document.createElement("span");
    spanText.textContent="Processing...";
    spinnerDiv.appendChild(spinnerCircle);
    spinnerDiv.appendChild(spanText);
    bubble.appendChild(spinnerDiv);
  } else {
    bubble.appendChild(renderMessageContent(text));
  }

  msg.appendChild(bubble);
  messagesDiv.appendChild(msg);
  setTimeout(()=>msg.classList.add("show"),50);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
  return msg;
}

imgBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  Array.from(e.target.files).forEach(file=>{
    const reader=new FileReader();
    reader.onload=()=>{selectedImages.push(reader.result); addMessage("", "user", false,[reader.result]);};
    reader.readAsDataURL(file);
  });
};
document.addEventListener("paste",e=>{
  for(let i=0;i<e.clipboardData.items.length;i++){
    if(e.clipboardData.items[i].type.indexOf("image")!==-1){
      const file=e.clipboardData.items[i].getAsFile();
      const reader=new FileReader();
      reader.onload=()=>{selectedImages.push(reader.result); addMessage("", "user", false,[reader.result]);};
      reader.readAsDataURL(file);
    }
  }
});

async function sendMessage(){
  const text=input.value.trim();
  if(!text && selectedImages.length===0) return;
  addMessage(text||"üì∑ ·∫¢nh","user",false,selectedImages);
  input.value="";
  const typingMsg=addMessage("", "ai", true);
  if(text) parts.push({
  text: "Vi·∫øt tr·ª±c ti·∫øp c√°c k√Ω t·ª± to√°n h·ªçc v√† s·ªë, kh√¥ng d√πng LaTeX. N·∫øu c·∫ßn, th√™m ch√∫ th√≠ch sau //."
});
  try{
    const parts=[];
    selectedImages.forEach(img=>parts.push({inline_data:{mime_type:"image/png",data:img.split(",")[1]}}));
    if(text) parts.push({text});
    const res=await fetch(endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts}]})});
    const data=await res.json();
    typingMsg.remove();
    const reply=data?.candidates?.[0]?.content?.parts?.[0]?.text || "‚ö†Ô∏è Kh√¥ng c√≥ ph·∫£n h·ªìi t·ª´ AI.";
    addMessage(reply,"ai");
  }catch(err){
    typingMsg.remove();
    addMessage("‚ùå L·ªói k·∫øt n·ªëi ho·∫∑c key kh√¥ng h·ª£p l·ªá.","ai");
  }
  selectedImages=[];
}

sendBtn.onclick=sendMessage;
input.addEventListener("keypress",e=>{if(e.key==="Enter") sendMessage();});
modeToggle.onclick=()=>document.body.classList.toggle("light");

// Info Modal Logic
const infoBtn=document.getElementById("infoBtn");
const infoModal=document.getElementById("infoModal");
const closeModal=document.getElementById("closeModal");
infoBtn.onclick=()=>infoModal.classList.add("show");
closeModal.onclick=()=>infoModal.classList.remove("show");
window.onclick=e=>{if(e.target===infoModal) infoModal.classList.remove("show");};
</script>
</body>
</html>
